<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscription Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- HEADER -->
  <header class="bg-white shadow p-4">
    <h1 class="text-2xl font-bold text-gray-700">Subscription Management</h1>
  </header>

  <div class="max-w-6xl mx-auto mt-8 p-4">

    <!-- NAVIGATION -->
    <div class="flex gap-4 mb-6">
      <button onclick="showPlans()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Subscription Plans</button>
      <button onclick="showRestaurantSubscriptions()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Restaurant Subscriptions</button>
    </div>

    <!-- =========================
         Subscription Plans Page
         ========================= -->
    <div id="plansPage">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Subscription Plans</h2>
        <button onclick="openPlanModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Plan</button>
      </div>

      <table class="min-w-full bg-white rounded shadow text-sm">
        <thead class="bg-gray-100 font-semibold text-gray-700">
          <tr>
            <th class="p-2 text-left">Plan Name</th>
            <th class="p-2 text-right">Price (RWF)</th>
            <th class="p-2 text-left">Duration</th>
            <th class="p-2 text-left">Features</th>
            <th class="p-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="plansTable"></tbody>
      </table>
    </div>

    <!-- =========================
         Restaurant Subscriptions Page
         ========================= -->
    <div id="restaurantSubsPage" class="hidden">
      <h2 class="text-xl font-semibold mb-4">Restaurant Subscriptions</h2>
      <table class="min-w-full bg-white rounded shadow text-sm">
        <thead class="bg-gray-100 font-semibold text-gray-700">
          <tr>
            <th class="p-2 text-left">Restaurant</th>
            <th class="p-2 text-left">Plan</th>
            <th class="p-2 text-left">Expiry Date</th>
            <th class="p-2 text-left">Status</th>
            <th class="p-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="restaurantSubsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- =========================
       Modals
       ========================= -->
  <!-- Add/Edit Plan Modal -->
  <div id="planModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-20">
    <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4" id="planModalTitle">Add Plan</h3>
      <input type="text" id="planName" placeholder="Plan Name" class="w-full p-2 border rounded mb-2">
      <input type="number" id="planPrice" placeholder="Price (RWF)" class="w-full p-2 border rounded mb-2">
      <input type="text" id="planDuration" placeholder="Duration (e.g., 30 days)" class="w-full p-2 border rounded mb-2">
      <textarea id="planFeatures" placeholder="Features" class="w-full p-2 border rounded mb-4"></textarea>

      <div class="flex justify-end gap-2">
        <button onclick="closePlanModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button onclick="savePlan()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" id="savePlanBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Change Plan Modal -->
  <div id="changePlanModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-20">
    <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">Change Plan</h3>
      <select id="newPlanSelect" class="w-full p-2 border rounded mb-4"></select>

      <div class="flex justify-end gap-2">
        <button onclick="closeChangePlanModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button onclick="saveChangePlan()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Change</button>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // Data
    // ===========================
    let subscriptionPlans = [
      { id: 1, name: "Basic", price: 5000, duration: "30 days", features: "Dashboard access, limited menu" },
      { id: 2, name: "Premium", price: 15000, duration: "90 days", features: "Full features + marketing tools" }
    ];

    let restaurantSubscriptions = [
      { id: 1, restaurant: "Sunset Grill", plan: "Premium", expiry: "2025-03-01", status: "Active" },
      { id: 2, restaurant: "Green Leaf CafÃ©", plan: "Basic", expiry: "2025-01-15", status: "Expired" },
      { id: 3, restaurant: "Royal Biryani House", plan: "Premium", expiry: "2025-04-01", status: "Active" }
    ];

    let editingPlanId = null;
    let changingSubId = null;

    // ===========================
    // Helper Functions
    // ===========================
    function formatPrice(amount) {
      return "RWF " + amount.toLocaleString();
    }

    function updateRestaurantStatuses() {
      let today = new Date();
      restaurantSubscriptions.forEach(sub => {
        sub.status = new Date(sub.expiry) < today ? "Expired" : "Active";
      });
    }

    // ===========================
    // Subscription Plans Page
    // ===========================
    function loadPlansTable() {
      const table = document.getElementById("plansTable");
      table.innerHTML = "";
      subscriptionPlans.forEach(plan => {
        const row = `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-2">${plan.name}</td>
            <td class="p-2 text-right">${formatPrice(plan.price)}</td>
            <td class="p-2">${plan.duration}</td>
            <td class="p-2">${plan.features}</td>
            <td class="p-2 flex gap-2">
              <button onclick="editPlan(${plan.id})" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs">Edit</button>
              <button onclick="deletePlan(${plan.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">Delete</button>
            </td>
          </tr>
        `;
        table.innerHTML += row;
      });
    }

    function openPlanModal() {
      editingPlanId = null;
      document.getElementById("planModalTitle").innerText = "Add Plan";
      document.getElementById("planName").value = "";
      document.getElementById("planPrice").value = "";
      document.getElementById("planDuration").value = "";
      document.getElementById("planFeatures").value = "";
      document.getElementById("planModal").classList.remove("hidden");
    }

    function closePlanModal() {
      document.getElementById("planModal").classList.add("hidden");
    }

    function savePlan() {
      const name = document.getElementById("planName").value.trim();
      const price = parseInt(document.getElementById("planPrice").value);
      const duration = document.getElementById("planDuration").value.trim();
      const features = document.getElementById("planFeatures").value.trim();
      if (!name || !price || !duration) { alert("Please fill all required fields."); return; }

      if (editingPlanId) {
        const plan = subscriptionPlans.find(p => p.id === editingPlanId);
        plan.name = name; plan.price = price; plan.duration = duration; plan.features = features;
        alert("Plan updated.");
      } else {
        subscriptionPlans.push({
          id: Date.now(),
          name, price, duration, features
        });
        alert("Plan added.");
      }
      closePlanModal();
      loadPlansTable();
    }

    function editPlan(id) {
      const plan = subscriptionPlans.find(p => p.id === id);
      if (!plan) return;
      editingPlanId = id;
      document.getElementById("planModalTitle").innerText = "Edit Plan";
      document.getElementById("planName").value = plan.name;
      document.getElementById("planPrice").value = plan.price;
      document.getElementById("planDuration").value = plan.duration;
      document.getElementById("planFeatures").value = plan.features;
      document.getElementById("planModal").classList.remove("hidden");
    }

    function deletePlan(id) {
      if (!confirm("Are you sure you want to delete this plan?")) return;
      subscriptionPlans = subscriptionPlans.filter(p => p.id !== id);
      loadPlansTable();
    }

    // ===========================
    // Restaurant Subscriptions Page
    // ===========================
    function loadRestaurantSubsTable() {
      updateRestaurantStatuses();
      const table = document.getElementById("restaurantSubsTable");
      table.innerHTML = "";
      restaurantSubscriptions.forEach(sub => {
        const statusClass = sub.status === "Active" ? "bg-green-600" : "bg-red-600";
        const row = `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-2">${sub.restaurant}</td>
            <td class="p-2">${sub.plan}</td>
            <td class="p-2">${sub.expiry}</td>
            <td class="p-2">
              <span class="px-2 py-1 rounded text-white text-xs ${statusClass}">${sub.status}</span>
            </td>
            <td class="p-2 flex gap-2">
              <button onclick="renewSub(${sub.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">Renew</button>
              <button onclick="openChangePlanModal(${sub.id})" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs">Change Plan</button>
            </td>
          </tr>
        `;
        table.innerHTML += row;
      });
    }

    function renewSub(id) {
      const sub = restaurantSubscriptions.find(s => s.id === id);
      if (!sub) return;
      const plan = subscriptionPlans.find(p => p.name === sub.plan);
      if (!plan) return;

      const currentExpiry = new Date(sub.expiry);
      const durationDays = parseInt(plan.duration);
      currentExpiry.setDate(currentExpiry.getDate() + durationDays);
      sub.expiry = currentExpiry.toISOString().split("T")[0];
      alert(`Subscription renewed for ${plan.duration}.`);
      loadRestaurantSubsTable();
    }

    function openChangePlanModal(subId) {
      changingSubId = subId;
      const select = document.getElementById("newPlanSelect");
      select.innerHTML = "";
      subscriptionPlans.forEach(p => {
        select.innerHTML += `<option value="${p.name}">${p.name} - ${formatPrice(p.price)} - ${p.duration}</option>`;
      });
      document.getElementById("changePlanModal").classList.remove("hidden");
    }

    function closeChangePlanModal() {
      document.getElementById("changePlanModal").classList.add("hidden");
    }

    function saveChangePlan() {
      const newPlanName = document.getElementById("newPlanSelect").value;
      const sub = restaurantSubscriptions.find(s => s.id === changingSubId);
      if (!sub) return;
      sub.plan = newPlanName;

      const plan = subscriptionPlans.find(p => p.name === newPlanName);
      if (plan) {
        const currentExpiry = new Date();
        currentExpiry.setDate(currentExpiry.getDate() + parseInt(plan.duration));
        sub.expiry = currentExpiry.toISOString().split("T")[0];
      }

      alert("Plan changed successfully.");
      closeChangePlanModal();
      loadRestaurantSubsTable();
    }

    // ===========================
    // Page Navigation
    // ===========================
    function showPlans() {
      document.getElementById("plansPage").classList.remove("hidden");
      document.getElementById("restaurantSubsPage").classList.add("hidden");
      loadPlansTable();
    }

    function showRestaurantSubscriptions() {
      document.getElementById("restaurantSubsPage").classList.remove("hidden");
      document.getElementById("plansPage").classList.add("hidden");
      loadRestaurantSubsTable();
    }

    // Init
    showPlans();
  </script>

</body>
</html>
