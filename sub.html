<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subscription Management Inline & Search</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<!-- HEADER -->
<header class="bg-white shadow p-4">
  <h1 class="text-2xl font-bold text-gray-700">Subscription Management</h1>
</header>

<div class="max-w-6xl mx-auto mt-8 p-4">

  <!-- NAVIGATION -->
  <div class="flex gap-4 mb-6">
    <button onclick="showPlans()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Subscription Plans</button>
    <button onclick="showRestaurantSubscriptions()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Restaurant Subscriptions</button>
  </div>

  <!-- =========================
       Subscription Plans Page
       ========================= -->
  <div id="plansPage">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Subscription Plans</h2>
      <button onclick="openPlanModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Plan</button>
    </div>

    <table class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100 font-semibold text-gray-700">
        <tr>
          <th class="p-2 text-left">Plan Name</th>
          <th class="p-2 text-right">Price (RWF)</th>
          <th class="p-2 text-left">Duration (days)</th>
          <th class="p-2 text-left">Features</th>
          <th class="p-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="plansTable"></tbody>
    </table>
  </div>

  <!-- =========================
       Restaurant Subscriptions Page
       ========================= -->
  <div id="restaurantSubsPage" class="hidden">
    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
      <h2 class="text-xl font-semibold">Restaurant Subscriptions</h2>

      <div class="flex gap-2 flex-wrap">
        <input type="text" id="searchInput" placeholder="Search restaurant, plan, or status..." class="p-2 border rounded text-sm">
        <select id="filterPlan" class="p-2 border rounded text-sm">
          <option value="">All Plans</option>
        </select>
        <select id="filterStatus" class="p-2 border rounded text-sm">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Expired">Expired</option>
        </select>
        <button onclick="exportCSV()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">Export CSV</button>
      </div>
    </div>

    <table class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100 font-semibold text-gray-700">
        <tr>
          <th class="p-2 text-left">Restaurant</th>
          <th class="p-2 text-left">Plan</th>
          <th class="p-2 text-left">Expiry Date</th>
          <th class="p-2 text-left">Status</th>
          <th class="p-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="restaurantSubsTable"></tbody>
    </table>

    <!-- Pagination -->
    <div class="flex justify-center mt-4 gap-2" id="pagination"></div>
  </div>
</div>

<!-- =========================
     Modals
     ========================= -->
<!-- Add/Edit Plan Modal -->
<div id="planModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-20">
  <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
    <h3 class="text-lg font-semibold mb-4" id="planModalTitle">Add Plan</h3>
    <input type="text" id="planName" placeholder="Plan Name" class="w-full p-2 border rounded mb-2">
    <input type="number" id="planPrice" placeholder="Price (RWF)" class="w-full p-2 border rounded mb-2">
    <input type="number" id="planDuration" placeholder="Duration (days)" class="w-full p-2 border rounded mb-2">
    <textarea id="planFeatures" placeholder="Features" class="w-full p-2 border rounded mb-4"></textarea>

    <div class="flex justify-end gap-2">
      <button onclick="closePlanModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
      <button onclick="savePlan()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" id="savePlanBtn">Save</button>
    </div>
  </div>
</div>

<script>
  // ===========================
  // Data
  // ===========================
  let subscriptionPlans = [
    { id: 1, name: "Basic", price: 5000, duration: 30, features: "Dashboard access, limited menu" },
    { id: 2, name: "Premium", price: 15000, duration: 90, features: "Full features + marketing tools" }
  ];

  let restaurantSubscriptions = [];
  for (let i = 1; i <= 45; i++) {
    restaurantSubscriptions.push({
      id: i,
      restaurant: "Restaurant " + i,
      plan: i % 2 === 0 ? "Basic" : "Premium",
      expiry: new Date(Date.now() + ((i % 2 === 0 ? 15 : 60) * 24 * 60 * 60 * 1000)).toISOString().split("T")[0],
      status: "Active"
    });
  }

  let editingPlanId = null;
  let currentPage = 1;
  const itemsPerPage = 10;

  // ===========================
  // Helper Functions
  // ===========================
  function formatPrice(amount) {
    return "RWF " + amount.toLocaleString();
  }

  function updateRestaurantStatuses() {
    let today = new Date();
    restaurantSubscriptions.forEach(sub => {
      sub.status = new Date(sub.expiry) < today ? "Expired" : "Active";
    });
  }

  // ===========================
  // Subscription Plans Page
  // ===========================
  function loadPlansTable() {
    const table = document.getElementById("plansTable");
    table.innerHTML = "";
    subscriptionPlans.forEach(plan => {
      const row = `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2">${plan.name}</td>
          <td class="p-2 text-right" contenteditable="true" onblur="updatePlanPrice(${plan.id}, this.innerText)">${formatPrice(plan.price)}</td>
          <td class="p-2">${plan.duration}</td>
          <td class="p-2">${plan.features}</td>
          <td class="p-2 flex gap-2">
            <button onclick="editPlan(${plan.id})" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs">Edit</button>
            <button onclick="deletePlan(${plan.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">Delete</button>
          </td>
        </tr>
      `;
      table.innerHTML += row;
    });

    const filterPlan = document.getElementById("filterPlan");
    filterPlan.innerHTML = '<option value="">All Plans</option>';
    subscriptionPlans.forEach(p => filterPlan.innerHTML += `<option value="${p.name}">${p.name}</option>`);
  }

  function updatePlanPrice(planId, value) {
    const numericValue = parseInt(value.replace(/[^\d]/g, ""));
    const plan = subscriptionPlans.find(p => p.id === planId);
    if (plan && numericValue) {
      plan.price = numericValue;
      loadRestaurantSubsTable();
    }
  }

  function openPlanModal() {
    editingPlanId = null;
    document.getElementById("planModalTitle").innerText = "Add Plan";
    document.getElementById("planName").value = "";
    document.getElementById("planPrice").value = "";
    document.getElementById("planDuration").value = "";
    document.getElementById("planFeatures").value = "";
    document.getElementById("planModal").classList.remove("hidden");
  }

  function closePlanModal() { document.getElementById("planModal").classList.add("hidden"); }

  function savePlan() {
    const name = document.getElementById("planName").value.trim();
    const price = parseInt(document.getElementById("planPrice").value);
    const duration = parseInt(document.getElementById("planDuration").value);
    const features = document.getElementById("planFeatures").value.trim();
    if (!name || !price || !duration) { alert("Please fill all required fields."); return; }

    if (editingPlanId) {
      const plan = subscriptionPlans.find(p => p.id === editingPlanId);
      plan.name = name; plan.price = price; plan.duration = duration; plan.features = features;
      alert("Plan updated.");
    } else {
      subscriptionPlans.push({ id: Date.now(), name, price, duration, features });
      alert("Plan added.");
    }
    closePlanModal();
    loadPlansTable();
    loadRestaurantSubsTable();
  }

  function editPlan(id) {
    const plan = subscriptionPlans.find(p => p.id === id);
    if (!plan) return;
    editingPlanId = id;
    document.getElementById("planModalTitle").innerText = "Edit Plan";
    document.getElementById("planName").value = plan.name;
    document.getElementById("planPrice").value = plan.price;
    document.getElementById("planDuration").value = plan.duration;
    document.getElementById("planFeatures").value = plan.features;
    document.getElementById("planModal").classList.remove("hidden");
  }

  function deletePlan(id) {
    if (!confirm("Are you sure you want to delete this plan?")) return;
    subscriptionPlans = subscriptionPlans.filter(p => p.id !== id);
    loadPlansTable();
    loadRestaurantSubsTable();
  }

  // ===========================
  // Restaurant Subscriptions Page
  // ===========================
  function loadRestaurantSubsTable() {
    updateRestaurantStatuses();
    const table = document.getElementById("restaurantSubsTable");
    const search = document.getElementById("searchInput")?.value?.toLowerCase() || "";
    const filterPlan = document.getElementById("filterPlan")?.value || "";
    const filterStatus = document.getElementById("filterStatus")?.value || "";

    const filtered = restaurantSubscriptions.filter(sub => {
      const searchMatch =
        sub.restaurant.toLowerCase().includes(search) ||
        sub.plan.toLowerCase().includes(search) ||
        sub.status.toLowerCase().includes(search);

      return searchMatch &&
             (!filterPlan || sub.plan === filterPlan) &&
             (!filterStatus || sub.status === filterStatus);
    });

    const totalPages = Math.ceil(filtered.length / itemsPerPage);
    if (currentPage > totalPages) currentPage = totalPages || 1;
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageItems = filtered.slice(start, end);

    table.innerHTML = "";
    pageItems.forEach(sub => {
      const statusClass = sub.status === "Active" ? "bg-green-600" : "bg-red-600";
      table.innerHTML += `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2">${sub.restaurant}</td>
          <td class="p-2">${sub.plan}</td>
          <td class="p-2"><input type="date" value="${sub.expiry}" class="border p-1 rounded text-sm" onchange="updateExpiry(${sub.id}, this.value)"></td>
          <td class="p-2"><span class="px-2 py-1 rounded text-white text-xs ${statusClass}">${sub.status}</span></td>
          <td class="p-2 flex gap-2">
            <button onclick="renewSub(${sub.id})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">Renew</button>
          </td>
        </tr>
      `;
    });

    // Pagination
    const paginationDiv = document.getElementById("pagination");
    paginationDiv.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.innerText = i;
      btn.className = `px-3 py-1 border rounded ${i === currentPage ? "bg-blue-600 text-white" : "bg-white hover:bg-gray-100"}`;
      btn.onclick = () => { currentPage = i; loadRestaurantSubsTable(); };
      paginationDiv.appendChild(btn);
    }
  }

  function updateExpiry(subId, newValue) {
    const sub = restaurantSubscriptions.find(s => s.id === subId);
    if (sub) {
      sub.expiry = newValue;
      loadRestaurantSubsTable();
    }
  }

  function renewSub(id) {
    const sub = restaurantSubscriptions.find(s => s.id === id);
    if (!sub) return;
    const plan = subscriptionPlans.find(p => p.name === sub.plan);
    if (!plan) return;
    const currentExpiry = new Date(sub.expiry);
    currentExpiry.setDate(currentExpiry.getDate() + plan.duration);
    sub.expiry = currentExpiry.toISOString().split("T")[0];
    loadRestaurantSubsTable();
  }

  // ===========================
  // Search / Filter / CSV
  // ===========================
  document.getElementById("searchInput")?.addEventListener("input", () => { currentPage = 1; loadRestaurantSubsTable(); });
  document.getElementById("filterPlan")?.addEventListener("change", () => { currentPage = 1; loadRestaurantSubsTable(); });
  document.getElementById("filterStatus")?.addEventListener("change", () => { currentPage = 1; loadRestaurantSubsTable(); });

  function exportCSV() {
    let csv = "Restaurant,Plan,Expiry,Status\n";
    restaurantSubscriptions.forEach(sub => { csv += `${sub.restaurant},${sub.plan},${sub.expiry},${sub.status}\n`; });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "restaurant_subscriptions.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // ===========================
  // Page Navigation
  // ===========================
  function showPlans() { document.getElementById("plansPage").classList.remove("hidden"); document.getElementById("restaurantSubsPage").classList.add("hidden"); loadPlansTable(); }
  function showRestaurantSubscriptions() { document.getElementById("restaurantSubsPage").classList.remove("hidden"); document.getElementById("plansPage").classList.add("hidden"); loadRestaurantSubsTable(); }

  // Init
  showPlans();
</script>
</body>
</html>



